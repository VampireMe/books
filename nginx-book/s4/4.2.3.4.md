# 过滤内容的缓存
***

&emsp;&emsp;
由于 nginx 设计流式的输出结构，当需要对响应内容作全文过滤的时候必须缓存部分的 buf 内容。
该类过滤模块往往比较复杂，比如 sub，ssi，gzip 等模块。
这类模块的设计非常灵活，简单讲一下设计原则：

+ 输入链 in 需要拷贝操作，经过缓存的过滤模块，输入输出链往往已经完全不一样了，所以需要拷贝，通过 ngx_chain_add_copy 函数完成。
+ 一般有自己的 free 和 busy 缓存链表池，可以提高 buf 分配效率。
+ 如果需要分配大块内容，一般分配固定大小的内存卡，并设置 recycled 标志，表示可以重复利用。
+ 原有的输入 buf 被替换缓存时，必须将其 buf->pos 设为 buf->last，表明原有的 buf 已经被输出完毕。
或者在新建立的 buf，将 buf->shadow 指向旧的 buf，以便输出完毕时及时释放旧的 buf。