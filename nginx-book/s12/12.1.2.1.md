# 解析请求行(99%)
***

&emsp;&emsp;
ngx_http_process_request_line 函数的主要作用即是解析请求行。
同样由于涉及到网络 IO 操作，即使是很短的一行请求行可能也不能被一次读完，所以在之前的 ngx_http_init_request 函数中 ngx_http_process_request_line 函数被设置为读事件的处理函数，它也只拥有一个唯一的 ngx_event_t * 类型参数。
并且在函数的开头同样需要判断是否是超时事件，如果是的话则关闭这个请求和连接；
否则开始正常的解析流程。
先调用 ngx_http_read_request_header 函数读取数据。

&emsp;&emsp;
由于可能多次进入 ngx_http_process_request_line 函数，ngx_http_read_request_header 函数首先检查请求的 header_in 指向的缓冲区内是否有数据，有的话直接返回；
否则从连接读取数据并保存在请求的 header_in 指向的缓存区，而且只要缓冲区有空间的话，会一次尽可能多的读数据，读到多少返回多少；
如果客户端暂时没有发任何数据过来，并返回 NGX_AGAIN，返回之前会做 2 件事情：

&emsp;&emsp;
(1) 设置一个定时器，时长默认为 60s，可以通过指令 client_header_timeout 设置，如果定时事件到达之前没有任何可读事件，nginx 将会关闭此请求；

&emsp;&emsp;
(2)调用 ngx_handle_read_event 函数处理一下读事件，如果该连接尚未在事件处理模型上挂载读事件，则将其挂载上；

&emsp;&emsp;
如果客户端提前关闭了连接或者读取数据发生了其他错误，则给客户端返回一个 400 错误(当然这里并不保证客户端能够接收到响应数据，因为客户端可能都已经关闭了连接)，最后函数返回 NGX_ERROR；

&emsp;&emsp;
如果 ngx_http_read_request_header 函数正常的读取到了数据，ngx_http_process_request_line 函数将调用 ngx_http_parse_request_line 函数来解析，这个函数根据 http 协议规范中对请求行的定义实现了一个有限状态机，经过这个状态机 nginx 会记录请求行中的请求方法( Method )，请求 uri 以及 http 协议版本在缓冲区中的起始位置，在解析过程中还会记录一些其他有用的信息，以便后面的处理过程中使用。
如果解析请求行的过程中没有产生任何问题，该函数会返回 NGX_OK；
如果请求行不满足协议规范，该函数会立即终止解析过程，并返回相应错误号；
如果缓冲区数据不够，该函数返回 NGX_AGAIN。

&emsp;&emsp;
在整个解析 http 请求的状态机中始终遵循着两条重要的原则：减少内存拷贝和回溯。

&emsp;&emsp;
内存拷贝是一个相对比较昂贵的操作，大量的内存拷贝会带来较低的运行时效率。
nginx 在需要做内存拷贝的地方尽量只拷贝内存的起始和结束地址而不是内存本身，这样做的话仅仅只需要两个赋值操作而已，大大降低了开销，当然这样带来的影响是后续的操作不能修改内存本身，如果修改的话，会影响到所有引用到该内存区间的地方，所以必须很小心的管理，必要的时候需要拷贝一份。

&emsp;&emsp;
这里不得不提到 nginx 中最能体现这一思想的数据结构 ngx_buf_t，它用来表示 nginx 中的缓存。
在很多情况下只需要将一块内存的起始地址和结束地址分别保存在它的 pos 和 last 成员中，再将它的 memory 标志置 1，即可表示一块不能修改的内存区间。
在另外的需要一块能够修改的缓存的情形中，则必须分配一块所需大小的内存并保存其起始地址，再将 ngx_buf_t 的 temporary 标志置 1，表示这是一块能够被修改的内存区域。

&emsp;&emsp;
再回到 ngx_http_process_request_line 函数中，如果 ngx_http_parse_request_line 函数返回了错误，则直接给客户端返回 400 错误；
如果返回 NGX_AGAIN，则需要判断一下是否是由于缓冲区空间不够，还是已读数据不够。
如果是缓冲区大小不够了，nginx 会调用 ngx_http_alloc_large_header_buffer 函数来分配另一块大缓冲区，如果大缓冲区还不够装下整个请求行，nginx 则会返回 414 错误给客户端，否则分配了更大的缓冲区并拷贝之前的数据之后，继续调用 ngx_http_read_request_header 函数读取数据来进入请求行自动机处理，直到请求行解析结束；

&emsp;&emsp;
如果返回了 NGX_OK，则表示请求行被正确的解析出来了，这时先记录好请求行的起始地址以及长度，并将请求 uri 的 path 和参数部分保存在请求结构的 uri 字段，请求方法起始位置和长度保存在 method_name 字段，http 版本起始位置和长度记录在 http_protocol 字段。
还要从 uri 中解析出参数以及请求资源的拓展名，分别保存在 args 和 exten 字段。
接下来将要解析请求头，将在下一小节中接着介绍。